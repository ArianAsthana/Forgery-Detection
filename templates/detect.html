{% extends "base.html" %}
{% block title %}Detect Forgery - PaperTrail{% endblock %}

{% block content %}
<section class="section-dark detect-section">
  <h1 class="sr-fade">Upload a Document for Analysis</h1>
  <p class="sr-fade">Our AI engine will inspect your document for signs of tampering.</p>

  <!-- Upload Box -->
  <div class="upload-container sr-fade" id="upload-area">
    <i class="fas fa-file-upload fa-3x upload-icon"></i>
    <p>Drag & drop your document here, or click below to upload</p>

    <form action="/detect" method="post" enctype="multipart/form-data" id="upload-form">
      <input type="file" name="document" id="document" accept="image/*,.pdf" onchange="submitForm()" hidden>
      <button type="button" class="upload-btn">Choose File</button>
    </form>
  </div>

  <!-- Loading Indicator -->
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
  </div>

  <!-- Result Section -->
  {% if result %}
  <section class="result-section sr-fade">
    <h2>Analysis Result</h2>
    <div class="result-summary">{{ result | safe }}</div>

    {% if highlighted_img and original_img %}
    <div class="result-grid">
      <div class="result-image-block">
        <h3>Original Document</h3>
        <img src="/static/uploads/{{ original_img }}" alt="Original Document">
      </div>
      <div class="result-image-block">
        <h3>Detected Tampering</h3>
        <img src="/static/results/{{ highlighted_img }}" alt="Highlighted Result">
      </div>
    </div>
    {% endif %}
  </section>
  {% endif %}
</section>

<!-- Upload Script -->
<script>
  const loading = document.getElementById("loading");

  function showLoading() {
    loading.classList.add("active");
  }

  function hideLoading() {
    loading.classList.remove("active");
  }

  function submitForm() {
    const form = document.getElementById("upload-form");
    const input = document.getElementById("document");
    if (input.files.length > 0) {
      showLoading();
      form.submit();
    }
  }

  // Drag-and-drop
  const uploadArea = document.getElementById("upload-area");
  const fileInput = document.getElementById("document");

  uploadArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadArea.classList.add("drag-over");
  });

  uploadArea.addEventListener("dragleave", () => {
    uploadArea.classList.remove("drag-over");
  });

  uploadArea.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadArea.classList.remove("drag-over");
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      submitForm();
    }
  });

  document.querySelector(".upload-btn").addEventListener("click", () => {
    fileInput.click();
  });
</script>
{% endblock %}
